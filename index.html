<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUZAFFAR BANK</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #00d2ff; background: linear-gradient(120deg, #00d2ff, #3a7bd5); margin: 0; padding: 0; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 90%; max-width: 450px; text-align: center; }
        h1 { margin-bottom: 20px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); }
        .auth-section, .bank-section { display: none; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group button, .input-group select { width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box; }
        .input-group input, .input-group select { background-color: rgba(255, 255, 255, 0.3); color: #fff; outline: none; transition: background-color 0.3s; }
        .input-group input:focus, .input-group select:focus { background-color: rgba(255, 255, 255, 0.5); }
        .input-group input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .btn { padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; color: #fff; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #3a7bd5; }
        .btn-secondary { background-color: #4caf50; margin-top: 10px; }
        .balance-info { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; text-align: left; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); }
        .transfer-history { text-align: left; margin-top: 30px; }
        .transfer-history h3 { border-bottom: 2px solid rgba(255, 255, 255, 0.5); padding-bottom: 10px; }
        .transfer-item { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .history-list { max-height: 200px; overflow-y: auto; padding-right: 10px; }
        .history-list::-webkit-scrollbar { width: 8px; }
        .history-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 4px; }
        .message { margin-top: 20px; color: #ffeb3b; }
        a { color: #ffeb3b; text-decoration: none; font-weight: bold; }
        .tab-buttons { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab-buttons button { background-color: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 10px 20px; cursor: pointer; border-radius: 10px; margin: 0 5px; }
        .tab-buttons button.active { background-color: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <div id="authSection" class="auth-section">
        <h1>MUZAFFAR BANK</h1>
        <div class="tab-buttons">
            <button id="loginTab" class="active">Вход</button>
            <button id="registerTab">Регистрация</button>
        </div>
        <div id="loginForm">
            <div class="input-group">
                <input type="email" id="loginEmail" placeholder="Email">
            </div>
            <div class="input-group">
                <input type="password" id="loginPassword" placeholder="Пароль">
            </div>
            <button class="btn btn-primary" onclick="login()">Войти</button>
        </div>
        <div id="registerForm" style="display:none;">
            <div class="input-group">
                <input type="email" id="registerEmail" placeholder="Email">
            </div>
            <div class="input-group">
                <input type="password" id="registerPassword" placeholder="Пароль">
            </div>
            <div class="input-group">
                <input type="text" id="userPhone" placeholder="Номер телефона">
            </div>
            <button class="btn btn-secondary" onclick="register()">Регистрация</button>
        </div>
    </div>

    <div id="bankSection" class="bank-section">
        <h1 id="welcomeMessage"></h1>
        <div class="balance-info">
            <p>Баланс:</p>
            <p>
                Сомони (TJS): <span id="balanceTJS">0</span><br>
                Доллар (USD): <span id="balanceUSD">0</span><br>
                Рубли (RUB): <span id="balanceRUB">0</span>
            </p>
        </div>
        <div class="input-group">
            <select id="currencySelect">
                <option value="TJS">Сомони (TJS)</option>
                <option value="USD">Доллар (USD)</option>
                <option value="RUB">Рубли (RUB)</option>
            </select>
        </div>
        <div class="input-group">
            <input type="text" id="recipientId" placeholder="Email получателя">
        </div>
        <div class="input-group">
            <input type="number" id="transferAmount" placeholder="Сумма перевода">
        </div>
        <button class="btn btn-primary" onclick="transfer()">Перевести</button>
        <button class="btn btn-secondary" onclick="logout()">Выйти</button>
        <div class="transfer-history">
            <h3>История переводов</h3>
            <div id="historyList" class="history-list"></div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAu-3nDoDijgkmFozFuGNhSsODArolpwA4",
        authDomain: "muzaffar-bank-427fa.firebaseapp.com",
        projectId: "muzaffar-bank-427fa",
        storageBucket: "muzaffar-bank-427fa.firebasestorage.app",
        messagingSenderId: "1076361280717",
        appId: "1:1076361280717:web:226ca42c35b740fd07fd84"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authSection = document.getElementById('authSection');
    const bankSection = document.getElementById('bankSection');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');

    loginTab.addEventListener('click', () => {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
    });

    registerTab.addEventListener('click', () => {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        registerTab.classList.add('active');
        loginTab.classList.remove('active');
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            authSection.style.display = 'none';
            bankSection.style.display = 'block';
            loadUserData(user);
        } else {
            authSection.style.display = 'block';
            bankSection.style.display = 'none';
        }
    });

    async function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const phone = document.getElementById('userPhone').value;
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('users').doc(userCredential.user.uid).set({
                balances: {
                    TJS: 0,
                    USD: 0,
                    RUB: 0
                },
                email: email,
                phone: phone
            });
            await db.collection('transactions').doc(userCredential.user.uid).set({
                history: []
            });
            alert("Регистрация успешна! Вы вошли в свой аккаунт.");
        } catch (error) {
            alert("Ошибка регистрации: " + error.message);
        }
    }

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
            alert("Вход выполнен успешно!");
        } catch (error) {
            alert("Ошибка входа: " + error.message);
        }
    }

    async function logout() {
        await auth.signOut();
    }

    async function loadUserData(user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            document.getElementById('welcomeMessage').innerText = `Добро пожаловать, ${userData.email}`;
            
            // Проверяем, является ли пользователь админом
            if (userData.isAdmin) {
                document.getElementById('balanceTJS').innerText = '∞';
                document.getElementById('balanceUSD').innerText = '∞';
                document.getElementById('balanceRUB').innerText = '∞';
            } else {
                // Если не админ, отображаем реальные балансы
                document.getElementById('balanceTJS').innerText = userData.balances.TJS || 0;
                document.getElementById('balanceUSD').innerText = userData.balances.USD || 0;
                document.getElementById('balanceRUB').innerText = userData.balances.RUB || 0;
            }
        }

        const transactionDoc = await db.collection('transactions').doc(user.uid).get();
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        if (transactionDoc.exists) {
            const transactions = transactionDoc.data().history || [];
            transactions.forEach(t => {
                const item = document.createElement('div');
                item.className = 'transfer-item';
                item.innerText = `Перевод на ${t.recipient} ${t.amount} ${t.currency} (${new Date(t.timestamp).toLocaleString()})`;
                historyList.appendChild(item);
            });
        }
    }

    async function transfer() {
        const recipientEmail = document.getElementById('recipientId').value;
        const amount = Number(document.getElementById('transferAmount').value);
        const currency = document.getElementById('currencySelect').value;
        const user = auth.currentUser;

        if (!user || amount <= 0 || !recipientEmail) {
            alert("Пожалуйста, заполните все поля корректно.");
            return;
        }

        const userDocRef = db.collection('users').doc(user.uid);
        const recipientDocRef = db.collection('users').where('email', '==', recipientEmail);

        try {
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userDocRef);
                const recipientSnapshot = await transaction.get(recipientDocRef);
                
                if (!userDoc.exists) {
                    throw new Error("Недостаточно средств.");
                }

                const userData = userDoc.data();
                const currentBalance = userData.balances[currency];

                if (!userData.isAdmin && currentBalance < amount) {
                    throw new Error("Недостаточно средств.");
                }

                if (recipientSnapshot.empty) {
                    throw new Error("Получатель не найден.");
                }

                const recipientDoc = recipientSnapshot.docs[0];
                const newBalance = userData.isAdmin ? currentBalance : currentBalance - amount;
                const recipientData = recipientDoc.data();

                // Обновляем баланс в выбранной валюте
                const newRecipientBalances = { ...recipientData.balances };
                newRecipientBalances[currency] = (newRecipientBalances[currency] || 0) + amount;
                
                transaction.update(userDocRef, { [`balances.${currency}`]: newBalance });
                transaction.update(recipientDoc.ref, { balances: newRecipientBalances });
                
                const userTransactionRef = db.collection('transactions').doc(user.uid);
                const recipientTransactionRef = db.collection('transactions').doc(recipientDoc.id);
                
                const userTransactionDoc = await transaction.get(userTransactionRef);
                const recipientTransactionDoc = await transaction.get(recipientTransactionRef);

                const userHistory = userTransactionDoc.data().history || [];
                const recipientHistory = recipientTransactionDoc.data().history || [];
                
                userHistory.push({ recipient: recipientEmail, amount: amount, currency: currency, type: 'sent', timestamp: Date.now() });
                recipientHistory.push({ recipient: userDoc.data().email, amount: amount, currency: currency, type: 'received', timestamp: Date.now() });
                
                transaction.update(userTransactionRef, { history: userHistory });
                transaction.update(recipientTransactionRef, { history: recipientHistory });
            });

            alert("Перевод выполнен успешно!");
            loadUserData(user);
        } catch (error) {
            alert("Ошибка перевода: " + error.message);
        }
    }
</script>
</body>
</html>

